<!DOCTYPE html>
<html lang="en">
<head>
    <title>three.js FPS / Strafe</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
</head>
<body>

<script>
    const mapa = [
        [0, 0, 1, 0, 0],
        [1, 0, 1, 0, 1],
        [0, 0, 0, 0, 0],
        [0, 1, 1, 1, 0],
        [0, 0, 0, 1, 0]
    ];
    let context_map = JSON.parse(JSON.stringify(mapa))
    const players = {}
    function start(){
        let id_bot = 0
        const is_respawn = spawn_player(id_bot, 0, 0, 0)
        if(!is_respawn){
            throw new Error('no respawn bot')
        }
        console.log("map before move player: ", context_map)
        move_player(id_bot, 0, 1, 0)
        move_player(id_bot, 1, 1, 0)
        move_player(id_bot, 2, 2, 0)
        console.log("map after move player: ", context_map)
    }
    
    function spawn_player(id_bot, x, y, r){
        const is_exist_bot = exist_player(id_bot)
        if(is_exist_bot){
            console.error(`bot exist in party: ${id_bot}`)
            return false
        }
        let temp_mov = {
            x: x,
            y: y,
            r: r,
            id_bot: id_bot
        }
        const is_legal = check_legal_state(id_bot, temp_mov)
        if(!is_legal){
            console.error(`ilegal respawn id_bot: ${id_bot}`)
            return false
        }
        players[id_bot] = temp_mov
        context_map[players[id_bot].x][players[id_bot].y] =  players[id_bot]
        return true
    }
    function move_player(id_bot, n_x, n_y){
        if(!exist_player(id_bot)){
            console.error(`bot no exist in party move_player: ${id_bot}`)
            return false
        }
        let temp_mov = {
            x: n_x,
            y: n_y,
            r: players[id_bot].r,
            id_bot: id_bot
        }
        if(!check_legal_move(id_bot, temp_mov)){
            console.error(`ilegal mov in party move_player: ${id_bot}`)
            return false            
        }
        if(!check_legal_state(id_bot, temp_mov)){
            console.error(`ilegal mov in party move_player: ${id_bot}`)
            return false
        }

        context_map[players[id_bot].x][players[id_bot].y] = 0
        context_map[n_x][n_y] = temp_mov
        players[id_bot] = temp_mov
        return true
    }
    
    function check_legal_move(id_bot, temp_mov){
        const {x, y} = temp_mov
        const x_player = players[id_bot].x
        const y_player = players[id_bot].y
        if(x - x_player >= 2){
            return false
        }
        if(x - x_player <= -2){
            return false
        }
         console.log(x - x_player)
        if(y - y_player >= 2){
            return false
        }
        console.log(y - y_player)
        if(y - y_player <= -2){
            return false
        }
        return true

    }
    function check_legal_state(id_bot, temp_mov){
        const {x, y, z} = temp_mov
        if( !(mapa[x][y] === 0)){
            console.error(new Error( `bot can't spawn in this: x: ${x}, y: ${y}, map: ${mapa[x][y]}`))
            return false
        }
        return true
    }
    function exist_player(id_bot){
        if(!players[id_bot]){
            return false
        }
        return true
    }
    start()



</script>
</body>
</html>
